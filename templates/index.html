<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel –ê–¥–º–∏–Ω–∫–∞</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 { margin-bottom: 10px; color: #333; }
        .stats { display: flex; gap: 20px; margin-top: 15px; }
        .stat { 
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .stat strong { color: #2563eb; }
        .stat-warn { background: #fef3c7; }
        .stat-warn strong { color: #f59e0b; }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
            white-space: nowrap;
            margin: 0;
        }
        
        .filter-group input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .filter-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin: 0;
        }
        
        .filter-group.loading-filter {
            background: #dbeafe;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #60a5fa;
        }
        
        .filter-group.unloading-filter {
            background: #fce7f3;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #f472b6;
        }
        
        .filter-group input:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover { background: #1d4ed8; }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover { background: #4b5563; }
        
        .btn-fullscreen {
            background: #6b7280;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-fullscreen:hover {
            background: #4b5563;
        }
        
        body.fullscreen .header,
        body.fullscreen .progress-bar-container,
        body.fullscreen .filters {
            display: none;
        }
        
        body.fullscreen .container {
            max-width: 100%;
            padding: 0;
        }
        
        body.fullscreen .products {
            border-radius: 0;
            height: 100vh;
            overflow: auto;
        }
        
        .fullscreen-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
        }
        
        body.fullscreen .fullscreen-controls {
            display: block;
        }
        
        .products {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-divider {
            background: #f3f4f6;
            padding: 12px 20px;
            font-weight: 600;
            color: #374151;
            border-top: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-top: 1px solid #eee;
            font-size: 14px;
        }
        
        tr:hover { background: #f8f9fa; }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            overflow: hidden;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar-container {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .progress-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 16px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            border-radius: 8px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üìä –£—á–µ—Ç –ö–ü–ó - –ü–æ–¥–≤–µ—Å—ã</h1>
            <div class="stats">
                <div class="stat">üì¶ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <strong id="total-all">‚Äî</strong></div>
                <div class="stat stat-warn">üîç –ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="total-shown">‚Äî</strong></div>
                <div class="stat auto-refresh">
                    <span class="pulse"></span>
                    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 10 —Å–µ–∫
                </div>
            </div>
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-label">
                <span class="pulse"></span>
                –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="progress-timer">10</span>—Å
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</label>
                    <input type="number" id="limit" min="1" max="10000" value="100">
                </div>
                
                <div class="filter-group loading-filter">
                    <input type="checkbox" id="no-time-filter">
                    <label for="no-time-filter" style="cursor: pointer;">–ó–∞–≥—Ä—É–∑–∫–∞:</label>
                    <input type="number" id="loading-limit" min="1" max="10000" value="10">
                </div>
                
                <div class="filter-group unloading-filter">
                    <input type="checkbox" id="unload-filter">
                    <label for="unload-filter" style="cursor: pointer;">–í—ã–≥—Ä—É–∑–∫–∞:</label>
                    <input type="number" id="unloading-limit" min="1" max="10000" value="10">
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn-primary" onclick="loadProducts(true)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn-fullscreen" onclick="toggleFullscreen()">
                    <span>‚õ∂</span> –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
                </button>
            </div>
        </div>
        
        <div class="fullscreen-controls">
            <button class="btn-secondary" onclick="toggleFullscreen()">‚úï –í—ã—Ö–æ–¥</button>
        </div>
        
        <div class="products">
            <table>
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>‚Ññ –ü–æ–¥–≤–µ—Å–∞</th>
                        <th>–í–∏–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</th>
                        <th>‚Ññ –ö–ü–ó</th>
                        <th>–ó–∞–∫–∞–∑—á–∏–∫</th>
                        <th>–ü—Ä–æ—Ñ–∏–ª—å</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–¶–≤–µ—Ç</th>
                    </tr>
                </thead>
                <tbody id="products-table">
                    <tr><td colspan="9" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let autoRefreshInterval;
        
        function loadProducts(showSpinner = false) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ä—É—á–Ω–æ–π –∫–ª–∏–∫
            const overlay = document.getElementById('loading-overlay');
            
            if (showSpinner) {
                overlay.classList.add('active');
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const params = new URLSearchParams();
            
            const limit = document.getElementById('limit').value;
            const noTimeFilter = document.getElementById('no-time-filter').checked;
            const unloadFilter = document.getElementById('unload-filter').checked;
            const loadingLimit = document.getElementById('loading-limit').value;
            const unloadingLimit = document.getElementById('unloading-limit').value;
            
            if (limit) params.append('limit', limit);
            params.append('days', '365'); // –í—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –∑–∞ –≥–æ–¥
            if (noTimeFilter) {
                params.append('no_time_filter', 'true');
                if (loadingLimit) params.append('loading_limit', loadingLimit);
            }
            if (unloadFilter) {
                params.append('unload_filter', 'true');
                if (unloadingLimit) params.append('unloading_limit', unloadingLimit);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            savedFilters = params.toString();
            
            fetch(`/api/products?${params}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('products-table').innerHTML = 
                            `<tr><td colspan="9" style="color: red;">–û—à–∏–±–∫–∞: ${data.error}</td></tr>`;
                        return;
                    }
                    
                    document.getElementById('total-all').textContent = data.total_all;
                    document.getElementById('total-shown').textContent = data.total;
                    
                    const tbody = document.getElementById('products-table');
                    
                    if (data.products.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="loading">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –¥–≤–æ–π–Ω–æ–π —Ä–µ–∂–∏–º (–ó–∞–≥—Ä—É–∑–∫–∞ + –í—ã–≥—Ä—É–∑–∫–∞)
                    if (data.dual_mode && data.unloading_products) {
                        let html = '';
                        
                        // –°–µ–∫—Ü–∏—è –ó–∞–≥—Ä—É–∑–∫–∞
                        html += '<tr class="section-divider"><td colspan="9">üì¶ –ó–ê–ì–†–£–ó–ö–ê</td></tr>';
                        html += data.products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                        
                        // –°–µ–∫—Ü–∏—è –í—ã–≥—Ä—É–∑–∫–∞
                        html += '<tr class="section-divider"><td colspan="9">üöö –í–´–ì–†–£–ó–ö–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</td></tr>';
                        html += data.unloading_products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                        
                        tbody.innerHTML = html;
                    } else {
                        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
                        tbody.innerHTML = data.products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(err => {
                    document.getElementById('products-table').innerHTML = 
                        `<tr><td colspan="9" style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</td></tr>`;
                })
                .finally(() => {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏
                    if (showSpinner) {
                        overlay.classList.remove('active');
                    }
                });
        }
        
        function resetFilters() {
            document.getElementById('limit').value = '100';
            document.getElementById('loading-limit').value = '10';
            document.getElementById('unloading-limit').value = '10';
            document.getElementById('no-time-filter').checked = false;
            document.getElementById('unload-filter').checked = false;
            loadProducts(true);
        }
        
        let autoRefreshEnabled = true;
        let savedFilters = null;
        
        function startAutoRefresh() {
            const refreshInterval = 10000; // 10 —Å–µ–∫—É–Ω–¥
            const updateFrequency = 100; // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –∫–∞–∂–¥—ã–µ 100–º—Å
            
            let elapsed = 0;
            let progressInterval;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            function resetProgress() {
                elapsed = 0;
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('progress-timer').textContent = '10';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            function updateProgress() {
                elapsed += updateFrequency;
                const percent = (elapsed / refreshInterval) * 100;
                const secondsLeft = Math.ceil((refreshInterval - elapsed) / 1000);
                
                document.getElementById('progress-fill').style.width = percent + '%';
                document.getElementById('progress-timer').textContent = secondsLeft;
                
                // –ö–æ–≥–¥–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è - –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                if (elapsed >= refreshInterval) {
                    if (autoRefreshEnabled && savedFilters) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –°–û–•–†–ê–ù–ï–ù–ù–´–ú–ò —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                        loadProductsWithParams(savedFilters);
                    }
                    resetProgress(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞—Ä
                }
            }
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (progressInterval) clearInterval(progressInterval);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            resetProgress();
            progressInterval = setInterval(updateProgress, updateFrequency);
        }
        
        function loadProductsWithParams(params) {
            fetch(`/api/products?${params}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('products-table').innerHTML = 
                            `<tr><td colspan="9" style="color: red;">–û—à–∏–±–∫–∞: ${data.error}</td></tr>`;
                        return;
                    }
                    
                    document.getElementById('total-all').textContent = data.total_all;
                    document.getElementById('total-shown').textContent = data.total;
                    
                    const tbody = document.getElementById('products-table');
                    
                    if (data.products.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="loading">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –¥–≤–æ–π–Ω–æ–π —Ä–µ–∂–∏–º (–ó–∞–≥—Ä—É–∑–∫–∞ + –í—ã–≥—Ä—É–∑–∫–∞)
                    if (data.dual_mode && data.unloading_products) {
                        let html = '';
                        
                        // –°–µ–∫—Ü–∏—è –ó–∞–≥—Ä—É–∑–∫–∞
                        html += '<tr class="section-divider"><td colspan="9">üì¶ –ó–ê–ì–†–£–ó–ö–ê</td></tr>';
                        html += data.products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                        
                        // –°–µ–∫—Ü–∏—è –í—ã–≥—Ä—É–∑–∫–∞
                        html += '<tr class="section-divider"><td colspan="9">üöö –í–´–ì–†–£–ó–ö–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</td></tr>';
                        html += data.unloading_products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                        
                        tbody.innerHTML = html;
                    } else {
                        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
                        tbody.innerHTML = data.products.map(p => `
                            <tr>
                                <td>${p.date || '‚Äî'}</td>
                                <td>${p.time || '‚Äî'}</td>
                                <td><strong>${p.number || '‚Äî'}</strong></td>
                                <td>${p.material_type || '‚Äî'}</td>
                                <td>${p.kpz_number || '‚Äî'}</td>
                                <td>${p.client || '‚Äî'}</td>
                                <td>${p.profile || '‚Äî'}</td>
                                <td><strong>${p.lamels_qty || 0}</strong></td>
                                <td>${p.color || '‚Äî'}</td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
                });
        }
        
        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen');
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadProducts(false);
        startAutoRefresh();
        
        // Enter –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadProducts();
            });
        });
    </script>
</body>
</html>
