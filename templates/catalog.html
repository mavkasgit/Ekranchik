<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π - Ekranchik</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 0 20px 0;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #f3f4f6;
            margin-bottom: 20px;
            position: sticky;
            top: 20px;
            z-index: 100;
            display: grid;
            grid-template-columns: minmax(200px, auto) auto 1fr;
            gap: 30px;
            align-items: center;
        }
        
        .header-title {
            white-space: nowrap;
        }
        
        .nav-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .header-stats {
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-nav {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-nav.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3), 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: scale(1.05);
        }
        
        .header h1 {
            color: #1f2937;
            font-size: 28px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .stat-item {
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .profile-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }
        
        .profile-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .profile-photo {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-photo:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .profile-photo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-close:hover {
            color: #1f2937;
        }
        
        .modal-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .profile-photo.no-photo {
            color: #9ca3af;
            font-size: 48px;
        }
        
        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .profile-params {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .param-label {
            color: #6b7280;
        }
        
        .param-value {
            color: #1f2937;
            font-weight: 500;
        }
        
        .profile-notes {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .profile-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            flex: 1;
            background: #3b82f6;
            color: white;
            padding: 8px;
            font-size: 13px;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 16px;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .view-toggle-btn {
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-toggle-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .view-toggle-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ */
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .catalog-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
        }
        
        .catalog-table thead th {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 13px;
        }
        
        .catalog-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }
        
        .catalog-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .catalog-table td {
            padding: 12px;
            vertical-align: middle;
        }
        
        .table-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .table-photo:hover {
            transform: scale(1.1);
        }
        
        .table-no-photo {
            width: 60px;
            height: 60px;
            background: #f3f4f6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #9ca3af;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .table-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .btn-edit:hover {
            background: #bfdbfe;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .btn-delete:hover {
            background: #fecaca;
        }
        
        /* Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .editing-row td {
            background: #fef3c7 !important;
        }
        
        .inline-input {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .inline-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
        }
        
        .btn-save {
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-save:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π</h1>
                <p style="color: #6b7280; margin-top: 4px; font-size: 12px;">–í—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Å —Ñ–æ—Ç–æ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</p>
            </div>
            <div class="nav-buttons">
                <button class="btn-nav" onclick="window.location.href='/'">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                <button class="btn-nav" onclick="window.location.href='/profiles'">üì∑ –ü—Ä–æ—Ñ–∏–ª–∏</button>
                <button class="btn-nav active">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
            </div>
            <div class="header-stats">
                <div class="stats">
                    <div class="stat-item">
                        <strong id="total-profiles">0</strong> –ø—Ä–æ—Ñ–∏–ª–µ–π
                    </div>
                    <button class="btn-primary" onclick="openCreateModal()" style="margin-left: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
                    <button class="btn-primary" onclick="loadCatalog()" style="margin-left: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
        
        <div style="padding: 0 30px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center;">
                <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è–º..." 
                       style="flex: 1; padding: 12px 20px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 15px;"
                       onkeyup="searchCatalog()">
                
                <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <select id="sort-select" onchange="loadCatalog()" 
                        style="padding: 12px 16px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 15px; cursor: pointer; background: white;">
                    <option value="updated_at">üìÖ –ü–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</option>
                    <option value="name">üî§ –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</option>
                    <option value="usage_count">üìä –ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                </select>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü–µ–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ table —Ä–µ–∂–∏–º–µ) -->
                <div id="table-controls" style="display: none; gap: 10px;">
                    <button class="btn-primary" onclick="addNewRow()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 10px 16px; font-size: 14px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                    </button>
                    <button id="edit-mode-btn" class="btn-primary" onclick="toggleEditMode()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 10px 16px; font-size: 14px;">
                        ‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    </button>
                </div>
                
                <div style="display: flex; gap: 8px; background: #f3f4f6; padding: 4px; border-radius: 10px;">
                    <button id="view-grid-btn" class="view-toggle-btn active" onclick="switchView('grid')" title="–°–µ—Ç–∫–∞">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                    </button>
                    <button id="view-table-btn" class="view-toggle-btn" onclick="switchView('table')" title="–¢–∞–±–ª–∏—Ü–∞">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="catalog-container" style="padding: 0 30px;">
            <div class="loading">
                <div class="spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞...
            </div>
        </div>
    </div>
    
    <script>
        function loadCatalog() {
            const container = document.getElementById('catalog-container');
            const searchValue = document.getElementById('search-input').value.trim();
            const sortValue = document.getElementById('sort-select').value;
            container.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞...</div>';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const params = new URLSearchParams();
            if (searchValue) params.append('search', searchValue);
            params.append('sort', sortValue);
            const url = `/api/catalog?${params.toString()}`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = '<div class="loading" style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }
                    
                    document.getElementById('total-profiles').textContent = data.total;
                    
                    if (data.profiles.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <h3>üì≠ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—É—Å—Ç</h3>
                                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª–µ–π —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∑–¥–µ—Å—å</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
                    if (currentView === 'table') {
                        renderTableView(data.profiles, container);
                    } else {
                        renderGridView(data.profiles, container);
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞:', err);
                    container.innerHTML = '<div class="loading" style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤ –≤–∏–¥–µ —Å–µ—Ç–∫–∏ (–∫–∞—Ä—Ç–æ—á–∫–∏)
        function renderGridView(profiles, container) {
            const grid = document.createElement('div');
            grid.className = 'catalog-grid';
            
            profiles.forEach(profile => {
                        const card = document.createElement('div');
                        card.className = 'profile-card';
                        
                        const photoHtml = profile.photo_thumb 
                            ? `<img src="${profile.photo_thumb}" alt="${profile.name}">`
                            : '<div class="no-photo">üì∑</div>';
                        
                        const photoClickHandler = profile.photo_full 
                            ? `onclick="viewPhoto('${profile.name}', '${profile.photo_full}')"`
                            : '';
                        
                        const quantityHtml = profile.quantity_per_hanger 
                            ? `<div class="param-row">
                                <span class="param-label">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å:</span>
                                <span class="param-value">${profile.quantity_per_hanger}</span>
                               </div>`
                            : '';
                        
                        const lengthHtml = profile.length
                            ? `<div class="param-row">
                                <span class="param-label">–î–ª–∏–Ω–∞:</span>
                                <span class="param-value">${profile.length} –º–º</span>
                               </div>`
                            : '';
                        
                        const notesHtml = profile.notes || '–ù–µ—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏–π';
                        
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è JSON
                        const profileDataJson = JSON.stringify({
                            name: profile.name,
                            quantity_per_hanger: profile.quantity_per_hanger,
                            length: profile.length,
                            notes: profile.notes
                        }).replace(/"/g, '&quot;');
                        
                        card.innerHTML = `
                            <div class="profile-photo ${profile.photo_thumb ? '' : 'no-photo'}" ${photoClickHandler}>
                                ${photoHtml}
                            </div>
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-params">
                                ${quantityHtml}
                                ${lengthHtml}
                            </div>
                            <div class="profile-notes">${notesHtml}</div>
                            <div class="profile-actions">
                                <button class="btn-edit" onclick='editProfile(${profileDataJson})'>‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button class="btn-delete" onclick="deleteProfile('${profile.name}')">üóëÔ∏è</button>
                            </div>
                        `;
                        
                grid.appendChild(card);
            });
            
            container.innerHTML = '';
            container.appendChild(grid);
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
        function renderTableView(profiles, container) {
            const table = document.createElement('table');
            table.className = 'catalog-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 80px;">–§–æ—Ç–æ</th>
                        <th style="width: 150px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th style="width: 120px;">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å</th>
                        <th style="width: 100px;">–î–ª–∏–Ω–∞ (–º–º)</th>
                        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
                        <th style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            profiles.forEach(profile => {
                const tr = document.createElement('tr');
                tr.id = `row-${profile.name}`;
                
                const photoHtml = profile.photo_thumb
                    ? `<img src="${profile.photo_thumb}" class="table-photo" onclick="handlePhotoClick('${profile.name}', '${profile.photo_full || profile.photo_thumb}')" alt="${profile.name}" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">`
                    : '<div class="table-no-photo" onclick="handlePhotoClick(\'\', \'\')" style="cursor: pointer;" title="–ù–µ—Ç —Ñ–æ—Ç–æ">üì∑</div>';
                
                tr.innerHTML = `
                    <td style="text-align: center;">${photoHtml}</td>
                    <td><strong>${profile.name}</strong></td>
                    <td style="text-align: center;">${profile.quantity_per_hanger || '-'}</td>
                    <td style="text-align: center;">${profile.length || '-'}</td>
                    <td>${profile.notes || '-'}</td>
                    <td style="text-align: center;">
                        <button class="btn-delete" onclick="deleteProfile('${profile.name}')">üóëÔ∏è</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∏–¥–∞–º–∏
        function switchView(view) {
            currentView = view;
            localStorage.setItem('catalog_view', view);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.getElementById('view-grid-btn').classList.toggle('active', view === 'grid');
            document.getElementById('view-table-btn').classList.toggle('active', view === 'table');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü–µ–π
            const tableControls = document.getElementById('table-controls');
            if (view === 'table') {
                tableControls.style.display = 'flex';
            } else {
                tableControls.style.display = 'none';
                isEditMode = false;
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadCatalog();
        }
        
        // Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
        function editInline(profileName) {
            // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (editingRow) {
                cancelInlineEdit();
            }
            
            const row = document.getElementById(`row-${profileName}`);
            if (!row) return;
            
            editingRow = row;
            row.classList.add('editing-row');
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const cells = row.querySelectorAll('td');
            const currentQuantity = cells[2].textContent.trim() === '-' ? '' : cells[2].textContent.trim();
            const currentLength = cells[3].textContent.trim() === '-' ? '' : cells[3].textContent.trim();
            const currentNotes = cells[4].textContent.trim() === '-' ? '' : cells[4].textContent.trim();
            
            // –ó–∞–º–µ–Ω—è–µ–º —è—á–µ–π–∫–∏ –Ω–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            cells[2].innerHTML = `<input type="number" class="inline-input" id="edit-quantity" value="${currentQuantity}" placeholder="–ö–æ–ª-–≤–æ">`;
            cells[3].innerHTML = `<input type="number" class="inline-input" id="edit-length" value="${currentLength}" placeholder="–î–ª–∏–Ω–∞">`;
            cells[4].innerHTML = `<textarea class="inline-input" id="edit-notes" rows="2" style="resize: vertical;">${currentNotes}</textarea>`;
            cells[5].innerHTML = `
                <div class="inline-actions">
                    <button class="btn-save" onclick="saveInlineEdit('${profileName}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-cancel" onclick="cancelInlineEdit()">‚úñÔ∏è –û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
            document.getElementById('edit-quantity').focus();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ inline –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function saveInlineEdit(profileName) {
            const quantity = document.getElementById('edit-quantity').value.trim();
            const length = document.getElementById('edit-length').value.trim();
            const notes = document.getElementById('edit-notes').value.trim();
            
            fetch(`/api/catalog/${profileName}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quantity_per_hanger: quantity ? parseInt(quantity) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes || ''
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    editingRow = null;
                    loadCatalog();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            });
        }
        
        // –û—Ç–º–µ–Ω–∞ inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cancelInlineEdit() {
            if (!editingRow) return;
            editingRow.classList.remove('editing-row');
            editingRow = null;
            loadCatalog();
        }
        
        // –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: grid –∏–ª–∏ table
        let currentView = localStorage.getItem('catalog_view') || 'grid';
        let isEditMode = false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã
        let newRowCounter = 0; // –°—á—ë—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('view-grid-btn').classList.toggle('active', currentView === 'grid');
            document.getElementById('view-table-btn').classList.toggle('active', currentView === 'table');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ—Å–ª–∏ –≤ table —Ä–µ–∂–∏–º–µ
            if (currentView === 'table') {
                document.getElementById('table-controls').style.display = 'flex';
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ localStorage
            const savedSort = localStorage.getItem('catalog_sort') || 'updated_at';
            document.getElementById('sort-select').value = savedSort;
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('sort-select').addEventListener('change', (e) => {
                localStorage.setItem('catalog_sort', e.target.value);
            });
        });
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            
            if (isEditMode) {
                btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                makeAllRowsEditable();
            } else {
                btn.textContent = '‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                saveAllRows();
            }
        }
        
        // –°–¥–µ–ª–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏
        function makeAllRowsEditable() {
            const rows = document.querySelectorAll('.catalog-table tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 6) return; // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —è—á–µ–µ–∫
                
                // –ù–∞–∑–≤–∞–Ω–∏–µ - –í–°–ï–ì–î–ê –¥–µ–ª–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º (–¥–ª—è –Ω–æ–≤—ã—Ö –ò —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫)
                const nameCell = cells[1];
                const currentName = nameCell.querySelector('strong')?.textContent || nameCell.textContent.trim();
                nameCell.innerHTML = `<input type="text" class="inline-input" value="${currentName}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è">`;
                
                // –ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å
                const qtyCell = cells[2];
                const currentQty = qtyCell.textContent.trim() === '-' ? '' : qtyCell.textContent.trim();
                qtyCell.innerHTML = `<input type="number" class="inline-input" value="${currentQty}" placeholder="–ö–æ–ª-–≤–æ">`;
                
                // –î–ª–∏–Ω–∞
                const lengthCell = cells[3];
                const currentLength = lengthCell.textContent.trim() === '-' ? '' : lengthCell.textContent.trim();
                lengthCell.innerHTML = `<input type="number" class="inline-input" value="${currentLength}" placeholder="–î–ª–∏–Ω–∞">`;
                
                // –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
                const notesCell = cells[4];
                const currentNotes = notesCell.textContent.trim() === '-' ? '' : notesCell.textContent.trim();
                notesCell.innerHTML = `<textarea class="inline-input" rows="2" style="resize: vertical;">${currentNotes}</textarea>`;
                
                row.classList.add('editing-row');
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
        function saveAllRows() {
            const rows = document.querySelectorAll('.catalog-table tbody tr.editing-row');
            let promises = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const nameInput = cells[1].querySelector('input');
                const qtyInput = cells[2].querySelector('input');
                const lengthInput = cells[3].querySelector('input');
                const notesInput = cells[4].querySelector('textarea');
                
                const newName = nameInput?.value.trim() || '';
                const qty = qtyInput?.value.trim() || '';
                const length = lengthInput?.value.trim() || '';
                const notes = notesInput?.value.trim() || '';
                
                if (!newName) {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏–º—è –∏–∑ ID —Å—Ç—Ä–æ–∫–∏
                const oldName = row.id.replace('row-', '');
                const isNewRow = row.classList.contains('new-row');
                
                const data = {
                    quantity_per_hanger: qty ? parseInt(qty) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes || ''
                };
                
                // –î–ª—è –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º PUT endpoint
                // (—Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                const targetName = isNewRow ? newName : (oldName !== newName && newName ? newName : oldName);
                const promise = fetch(`/api/catalog/${encodeURIComponent(targetName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => res.json());
                promises.push(promise);
            });
            
            if (promises.length === 0) {
                loadCatalog();
                return;
            }
            
            Promise.all(promises).then(results => {
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', results);
                const allSuccess = results.every(r => r.success);
                const successCount = results.filter(r => r.success).length;
                
                if (allSuccess) {
                    showSuccessMessage(`‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! (${successCount} —Å—Ç—Ä–æ–∫)`);
                } else {
                    const failedCount = results.length - successCount;
                    alert(`‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${failedCount}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
                    console.error('–û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', results.filter(r => !r.success));
                }
                loadCatalog();
            }).catch(err => {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)');
                loadCatalog();
            });
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        function addNewRow() {
            const tbody = document.querySelector('.catalog-table tbody');
            if (!tbody) return;
            
            newRowCounter++;
            const tr = document.createElement('tr');
            tr.id = `row-new-${newRowCounter}`;
            tr.classList.add('new-row', 'editing-row');
            
            tr.innerHTML = `
                <td style="text-align: center;">
                    <div class="table-no-photo" onclick="uploadPhotoForNewRow('new-${newRowCounter}')" style="cursor: pointer;" title="–ö–ª–∏–∫–Ω–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</div>
                </td>
                <td><input type="text" class="inline-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"></td>
                <td style="text-align: center;"><input type="number" class="inline-input" placeholder="–ö–æ–ª-–≤–æ"></td>
                <td style="text-align: center;"><input type="number" class="inline-input" placeholder="–î–ª–∏–Ω–∞"></td>
                <td><textarea class="inline-input" rows="2" style="resize: vertical;" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è"></textarea></td>
                <td style="text-align: center;">
                    <button class="btn-delete" onclick="this.closest('tr').remove()">üóëÔ∏è</button>
                </td>
            `;
            
            tbody.insertBefore(tr, tbody.firstChild);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (!isEditMode) {
                toggleEditMode();
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ
            tr.querySelector('input').focus();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ—Ç–æ (–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        function handlePhotoClick(profileName, photoUrl) {
            if (isEditMode) {
                // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
                uploadPhotoForRow(profileName, false);
            } else {
                // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
                if (photoUrl) {
                    viewPhoto(profileName, photoUrl);
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        function uploadPhotoForNewRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (!row) return;
            
            const nameInput = row.querySelector('td:nth-child(2) input');
            if (!nameInput) return;
            
            const inputName = nameInput.value.trim();
            if (!inputName) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                nameInput.focus();
                return;
            }
            
            currentProfile = inputName;
            currentUploadingRow = rowId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å—Ç—Ä–æ–∫–∏
            showPhotoUpload();
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è —Å—Ç—Ä–æ–∫–∏
        function uploadPhotoForRow(profileName, isNewProfile = false) {
            currentUploadingRow = profileName;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ input
            if (isNewProfile) {
                const row = document.getElementById(`row-${profileName}`);
                if (row) {
                    const nameInput = row.querySelector('td:nth-child(2) input');
                    if (nameInput) {
                        const inputName = nameInput.value.trim();
                        if (inputName) {
                            currentUploadingRow = inputName;
                            currentProfile = inputName;
                        } else {
                            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                            nameInput.focus();
                            return;
                        }
                    }
                }
            } else {
                currentProfile = profileName;
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ (—Ç–æ –∂–µ —á—Ç–æ –≤ editProfile)
            showPhotoUpload();
        }
        
        let currentEditProfile = null;
        let currentUploadingRow = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ
        let currentEditProfileData = null;
        let newPhotoFile = null;
        let editingRow = null; // –°—Ç—Ä–æ–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let cropCanvas = null;
        let cropCtx = null;
        let cropImage = null;
        let cropData = { x: 0, y: 0, width: 0, height: 0 };
        let isDragging = false;
        let isMoving = false;
        let startX = 0;
        let startY = 0;
        let initialCropData = null;
        
        function editProfile(profileData) {
            currentEditProfile = profileData.name;
            currentEditProfileData = profileData;
            
            document.getElementById('edit-profile-name').textContent = profileData.name;
            document.getElementById('edit-quantity').value = profileData.quantity_per_hanger || '';
            document.getElementById('edit-length').value = profileData.length || '';
            document.getElementById('edit-notes').value = profileData.notes || '';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ DOM –¥–ª—è —Ñ–æ—Ç–æ
            const profileCard = event.target.closest('.profile-card');
            const photoImg = profileCard?.querySelector('.profile-photo img');
            const currentPhoto = document.getElementById('current-photo');
            
            if (photoImg && photoImg.src) {
                currentPhoto.src = photoImg.src;
                document.getElementById('current-photo-section').style.display = 'block';
            } else {
                document.getElementById('current-photo-section').style.display = 'none';
            }
            
            document.getElementById('edit-modal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditProfile = null;
            currentEditProfileData = null;
            newPhotoFile = null;
        }
        
        // ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º edit modal
                const editModal = document.getElementById('edit-modal');
                if (editModal && editModal.classList.contains('active')) {
                    closeEditModal();
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º view modal
                const viewModal = document.getElementById('view-modal');
                if (viewModal && viewModal.classList.contains('active')) {
                    closeViewModal();
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º delete confirm modal
                const deleteModal = document.getElementById('delete-confirm-modal');
                if (deleteModal && deleteModal.classList.contains('active')) {
                    closeDeleteModal();
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º create modal step 1
                const createStep1 = document.getElementById('create-modal-step1');
                if (createStep1 && createStep1.classList.contains('active')) {
                    closeCreateModal();
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º create modal step 2
                const createStep2 = document.getElementById('create-modal-step2');
                if (createStep2 && createStep2.classList.contains('active')) {
                    closeCreateModal();
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º upload photo modal
                const uploadModal = document.getElementById('upload-photo-modal');
                if (uploadModal && uploadModal.classList.contains('active')) {
                    closePhotoUpload();
                }
            }
        });
        
        // === –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è ===
        let createCropImage = null;
        let createCropData = { x: 0, y: 0, width: 0, height: 0 };
        let createIsDragging = false;
        let createIsMoving = false;
        let createStartX = 0;
        let createStartY = 0;
        let createPhotoFile = null;
        
        function openCreateModal() {
            document.getElementById('create-modal-step1').classList.add('active');
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('create-name').value = '';
            document.getElementById('create-quantity').value = '';
            document.getElementById('create-length').value = '';
            document.getElementById('create-notes').value = '';
            createCropImage = null;
            createPhotoFile = null;
        }
        
        function closeCreateModal() {
            document.getElementById('create-modal-step1').classList.remove('active');
            document.getElementById('create-modal-step2').classList.remove('active');
            createCropImage = null;
            createPhotoFile = null;
            document.removeEventListener('paste', handleCreatePaste);
        }
        
        function goToCreateStep2() {
            const name = document.getElementById('create-name').value.trim();
            if (!name) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è!');
                return;
            }
            document.getElementById('create-modal-step1').classList.remove('active');
            document.getElementById('create-modal-step2').classList.add('active');
            document.getElementById('create-photo-file').value = '';
            document.getElementById('create-upload-zone').style.display = 'block';
            document.getElementById('create-photo-preview').style.display = 'none';
            document.getElementById('create-rotation-slider').value = 0;
            document.getElementById('create-rotation-value').textContent = '0¬∞';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏
            document.addEventListener('paste', handleCreatePaste);
        }
        
        function backToCreateStep1() {
            document.getElementById('create-modal-step2').classList.remove('active');
            document.getElementById('create-modal-step1').classList.add('active');
            createCropImage = null;
            createPhotoFile = null;
            document.removeEventListener('paste', handleCreatePaste);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
        function handleCreatePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            createPhotoFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    createCropImage = img;
                    initCreateCropCanvas();
                    document.getElementById('create-upload-zone').style.display = 'none';
                    document.getElementById('create-photo-preview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleCreatePaste(e) {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    createPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            createCropImage = img;
                            initCreateCropCanvas();
                            document.getElementById('create-upload-zone').style.display = 'none';
                            document.getElementById('create-photo-preview').style.display = 'block';
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault();
                    break;
                }
            }
        }
        
        // Drag & drop –¥–ª—è create
        document.addEventListener('DOMContentLoaded', () => {
            const zone = document.getElementById('create-upload-zone');
            if (!zone) return;
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.style.borderColor = '#3b82f6';
                zone.style.background = '#eff6ff';
            });
            
            zone.addEventListener('dragleave', () => {
                zone.style.borderColor = '#cbd5e1';
                zone.style.background = 'transparent';
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.style.borderColor = '#cbd5e1';
                zone.style.background = 'transparent';
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    createPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            createCropImage = img;
                            initCreateCropCanvas();
                            document.getElementById('create-upload-zone').style.display = 'none';
                            document.getElementById('create-photo-preview').style.display = 'block';
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
        
        function initCreateCropCanvas() {
            const cropCanvas = document.getElementById('create-crop-canvas');
            const cropCtx = cropCanvas.getContext('2d');
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
            const maxWidth = 500;
            const scale = Math.min(1, maxWidth / createCropImage.width);
            cropCanvas.width = createCropImage.width * scale;
            cropCanvas.height = createCropImage.height * scale;
            
            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            cropCtx.drawImage(createCropImage, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—Ä–æ–ø - –ö–í–ê–î–†–ê–¢ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6;
            createCropData = {
                x: (cropCanvas.width - recommendedSize) / 2,
                y: (cropCanvas.height - recommendedSize) / 2,
                width: recommendedSize,
                height: recommendedSize
            };
            
            drawCreateCropBox();
            updateCreatePreview();
            initCreateCropHandlers();
        }
        
        function initCreateCropHandlers() {
            const cropCanvas = document.getElementById('create-crop-canvas');
            let initialCropData = null;
            
            cropCanvas.addEventListener('mousedown', (e) => {
                const rect = cropCanvas.getBoundingClientRect();
                const scaleX = cropCanvas.width / rect.width;
                const scaleY = cropCanvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                if (mouseX >= createCropData.x && mouseX <= createCropData.x + createCropData.width &&
                    mouseY >= createCropData.y && mouseY <= createCropData.y + createCropData.height) {
                    createIsMoving = true;
                    createStartX = mouseX;
                    createStartY = mouseY;
                    initialCropData = { ...createCropData };
                    cropCanvas.style.cursor = 'move';
                } else {
                    createIsDragging = true;
                    createStartX = mouseX;
                    createStartY = mouseY;
                    cropCanvas.style.cursor = 'crosshair';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!cropCanvas || (!createIsDragging && !createIsMoving)) return;
                const rect = cropCanvas.getBoundingClientRect();
                const scaleX = cropCanvas.width / rect.width;
                const scaleY = cropCanvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                if (createIsMoving) {
                    const dx = mouseX - createStartX;
                    const dy = mouseY - createStartY;
                    createCropData.x = Math.max(0, Math.min(cropCanvas.width - createCropData.width, initialCropData.x + dx));
                    createCropData.y = Math.max(0, Math.min(cropCanvas.height - createCropData.height, initialCropData.y + dy));
                } else if (createIsDragging) {
                    createCropData.x = Math.min(createStartX, mouseX);
                    createCropData.y = Math.min(createStartY, mouseY);
                    createCropData.width = Math.abs(mouseX - createStartX);
                    createCropData.height = Math.abs(mouseY - createStartY);
                }
                
                drawCreateCropBox();
                updateCreatePreview();
            });
            
            document.addEventListener('mouseup', () => {
                createIsDragging = false;
                createIsMoving = false;
                if (cropCanvas) cropCanvas.style.cursor = 'default';
            });
        }
        
        function drawCreateCropBox() {
            const cropCanvas = document.getElementById('create-crop-canvas');
            const cropCtx = cropCanvas.getContext('2d');
            if (!cropCanvas || !cropCtx || !createCropImage) return;
            
            // –û—á–∏—â–∞–µ–º –∏ —Ä–∏—Å—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.drawImage(createCropImage, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // –ó–∞—Ç–µ–º–Ω—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
            cropCtx.save();
            cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.globalCompositeOperation = 'destination-out';
            cropCtx.fillRect(createCropData.x, createCropData.y, createCropData.width, createCropData.height);
            cropCtx.restore();
            
            // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É
            cropCtx.strokeStyle = '#3b82f6';
            cropCtx.lineWidth = 2;
            cropCtx.strokeRect(createCropData.x, createCropData.y, createCropData.width, createCropData.height);
        }
        
        function updateCreatePreview() {
            const previewCanvas = document.getElementById('create-preview-canvas');
            const cropCanvas = document.getElementById('create-crop-canvas');
            if (!previewCanvas || !createCropImage || !cropCanvas) return;
            
            const previewCtx = previewCanvas.getContext('2d');
            const scale = createCropImage.width / cropCanvas.width;
            
            const srcX = createCropData.x * scale;
            const srcY = createCropData.y * scale;
            const srcWidth = createCropData.width * scale;
            const srcHeight = createCropData.height * scale;
            
            const maxSize = 300;
            let previewWidth = srcWidth;
            let previewHeight = srcHeight;
            if (previewWidth > maxSize || previewHeight > maxSize) {
                if (previewWidth > previewHeight) {
                    previewHeight = (previewHeight / previewWidth) * maxSize;
                    previewWidth = maxSize;
                } else {
                    previewWidth = (previewWidth / previewHeight) * maxSize;
                    previewHeight = maxSize;
                }
            }
            
            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;
            previewCtx.drawImage(
                createCropImage,
                srcX, srcY, srcWidth, srcHeight,
                0, 0, previewWidth, previewHeight
            );
            
            applyCreatePreviewFilters();
            
            const sizeText = document.getElementById('create-preview-size');
            if (sizeText) {
                sizeText.textContent = `${Math.round(previewWidth)}√ó${Math.round(previewHeight)}px`;
            }
        }
        
        function applyCreatePreviewFilters() {
            const preview = document.getElementById('create-preview-canvas');
            if (!preview) return;
            const rotation = parseFloat(document.getElementById('create-rotation-slider').value);
            preview.style.transform = `rotate(${rotation}deg)`;
        }
        
        function setCreateRotation(deg) {
            document.getElementById('create-rotation-slider').value = deg;
            document.getElementById('create-rotation-value').textContent = deg + '¬∞';
            applyCreatePreviewFilters();
        }
        
        function resetCreateCrop() {
            const cropCanvas = document.getElementById('create-crop-canvas');
            if (!cropCanvas) return;
            const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6;
            createCropData = {
                x: (cropCanvas.width - recommendedSize) / 2,
                y: (cropCanvas.height - recommendedSize) / 2,
                width: recommendedSize,
                height: recommendedSize
            };
            drawCreateCropBox();
            updateCreatePreview();
        }
        
        function createNewProfile() {
            const name = document.getElementById('create-name').value.trim();
            const quantity = document.getElementById('create-quantity').value;
            const length = document.getElementById('create-length').value;
            const notes = document.getElementById('create-notes').value.trim();
            const rotation = parseInt(document.getElementById('create-rotation-slider').value);
            
            if (!name) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è!');
                return;
            }
            
            if (!createPhotoFile) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è!');
                return;
            }
            
            const btn = document.querySelector('#create-modal-step2 .btn-primary');
            btn.disabled = true;
            btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ base64
            const reader = new FileReader();
            reader.onload = (e) => {
                // Crop –¥–∞–Ω–Ω—ã–µ - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
                const cropCanvas = document.getElementById('create-crop-canvas');
                const scale = cropCanvas.width / createCropImage.width;
                
                const payload = {
                    profile_name: name,
                    quantity_per_hanger: quantity || '',
                    length: length || '',
                    notes: notes || '',
                    image_data: e.target.result,  // base64
                    rotation: rotation,
                    crop_data: {
                        x: Math.round(createCropData.x / scale),
                        y: Math.round(createCropData.y / scale),
                        width: Math.round(createCropData.width / scale),
                        height: Math.round(createCropData.height / scale)
                    }
                };
                
                fetch('/api/profiles/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    btn.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                    
                    if (data.success) {
                        showSuccessMessage('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                        closeCreateModal();
                        loadCatalog();
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(err => {
                    btn.disabled = false;
                    btn.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
                });
            };
            
            reader.readAsDataURL(createPhotoFile);
        }
        
        function showPhotoUpload() {
            document.getElementById('upload-photo-modal').classList.add('active');
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('upload-zone').style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞
            document.addEventListener('paste', handlePaste);
        }
        
        function closePhotoUpload() {
            document.getElementById('upload-photo-modal').classList.remove('active');
            newPhotoFile = null;
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏
            document.removeEventListener('paste', handlePaste);
        }
        
        function handlePaste(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
            if (!document.getElementById('upload-photo-modal').classList.contains('active')) {
                return;
            }
            
            const items = event.clipboardData?.items;
            if (!items) return;
            
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            loadImageForCrop(e.target.result);
                        };
                        reader.readAsDataURL(file);
                        event.preventDefault();
                        break;
                    }
                }
            }
        }
        
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                loadImageForCrop(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function loadImageForCrop(imageData) {
            newPhotoFile = imageData;
            
            cropImage = new Image();
            cropImage.onload = function() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas
                cropCanvas = document.getElementById('crop-canvas');
                cropCtx = cropCanvas.getContext('2d');
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
                const maxWidth = 500;
                const scale = Math.min(1, maxWidth / cropImage.width);
                cropCanvas.width = cropImage.width * scale;
                cropCanvas.height = cropImage.height * scale;
                
                // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—Ä–æ–ø - –ö–í–ê–î–†–ê–¢ –ø–æ —Ü–µ–Ω—Ç—Ä—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
                const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6; // 60% –æ—Ç –º–µ–Ω—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã
                cropData = {
                    x: (cropCanvas.width - recommendedSize) / 2,
                    y: (cropCanvas.height - recommendedSize) / 2,
                    width: recommendedSize,
                    height: recommendedSize
                };
                
                drawCropBox();
                updatePreview();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                document.getElementById('photo-preview').style.display = 'block';
                document.getElementById('upload-zone').style.display = 'none';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                initCropHandlers();
            };
            cropImage.src = imageData;
        }
        
        function initCropHandlers() {
            cropCanvas.addEventListener('mousedown', (e) => {
                const rect = cropCanvas.getBoundingClientRect();
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–î–í–ò–ì–ê: —É—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± canvas
                const scaleX = cropCanvas.width / rect.width;
                const scaleY = cropCanvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏ (–¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
                if (mouseX >= cropData.x && mouseX <= cropData.x + cropData.width &&
                    mouseY >= cropData.y && mouseY <= cropData.y + cropData.height) {
                    isMoving = true;
                    startX = mouseX;
                    startY = mouseY;
                    initialCropData = { ...cropData };
                    cropCanvas.style.cursor = 'move';
                } else {
                    // –ù–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    isDragging = true;
                    startX = mouseX;
                    startY = mouseY;
                    cropCanvas.style.cursor = 'crosshair';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!cropCanvas || (!isDragging && !isMoving)) return;
                
                const rect = cropCanvas.getBoundingClientRect();
                const scaleX = cropCanvas.width / rect.width;
                const scaleY = cropCanvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                if (isMoving) {
                    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ä–∞–º–∫–∏
                    const dx = mouseX - startX;
                    const dy = mouseY - startY;
                    cropData.x = Math.max(0, Math.min(cropCanvas.width - cropData.width, initialCropData.x + dx));
                    cropData.y = Math.max(0, Math.min(cropCanvas.height - cropData.height, initialCropData.y + dy));
                } else if (isDragging) {
                    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞–º–∫–∏
                    cropData.x = Math.min(startX, mouseX);
                    cropData.y = Math.min(startY, mouseY);
                    cropData.width = Math.abs(mouseX - startX);
                    cropData.height = Math.abs(mouseY - startY);
                }
                
                drawCropBox();
                updatePreview();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                isMoving = false;
                cropCanvas.style.cursor = 'default';
            });
        }
        
        function drawCropBox() {
            if (!cropCanvas || !cropCtx || !cropImage) return;
            
            // 1. –û—á–∏—â–∞–µ–º –∏ —Ä–∏—Å—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // 2. –ó–∞—Ç–µ–º–Ω—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
            cropCtx.save();
            
            // –ó–∞—Ç–µ–º–Ω—è–µ–º –≤–µ—Å—å canvas
            cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'destination-out' —á—Ç–æ–±—ã –≤—ã—Ä–µ–∑–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –∏–∑ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
            cropCtx.globalCompositeOperation = 'destination-out';
            cropCtx.fillRect(cropData.x, cropData.y, cropData.width, cropData.height);
            
            cropCtx.restore();
            
            // 3. –†–∏—Å—É–µ–º —Ä–∞–º–∫—É
            cropCtx.strokeStyle = '#3b82f6';
            cropCtx.lineWidth = 2;
            cropCtx.strokeRect(cropData.x, cropData.y, cropData.width, cropData.height);
        }
        
        function updatePreview() {
            const previewCanvas = document.getElementById('preview-canvas');
            if (!previewCanvas || !cropImage) return;
            
            const previewCtx = previewCanvas.getContext('2d');
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –æ—Ç canvas –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
            const scale = cropImage.width / cropCanvas.width;
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
            const srcX = cropData.x * scale;
            const srcY = cropData.y * scale;
            const srcWidth = cropData.width * scale;
            const srcHeight = cropData.height * scale;
            
            // Resize –¥–æ 300px max (—Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏)
            const maxSize = 300;
            let previewWidth = srcWidth;
            let previewHeight = srcHeight;
            
            if (previewWidth > maxSize || previewHeight > maxSize) {
                if (previewWidth > previewHeight) {
                    previewHeight = (previewHeight / previewWidth) * maxSize;
                    previewWidth = maxSize;
                } else {
                    previewWidth = (previewWidth / previewHeight) * maxSize;
                    previewHeight = maxSize;
                }
            }
            
            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;
            
            // –†–∏—Å—É–µ–º –ø—Ä–µ–≤—å—é
            previewCtx.drawImage(
                cropImage,
                srcX, srcY, srcWidth, srcHeight,
                0, 0, previewWidth, previewHeight
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
            const sizeText = document.getElementById('preview-size');
            if (sizeText) {
                sizeText.textContent = `${Math.round(previewWidth)}√ó${Math.round(previewHeight)}px`;
            }
        }
        
        function resetCrop() {
            if (!cropCanvas) return;
            
            // –°–±—Ä–æ—Å –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä (–∫–≤–∞–¥—Ä–∞—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É)
            const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6;
            cropData = {
                x: (cropCanvas.width - recommendedSize) / 2,
                y: (cropCanvas.height - recommendedSize) / 2,
                width: recommendedSize,
                height: recommendedSize
            };
            
            drawCropBox();
            updatePreview();
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫ –ø—Ä–µ–≤—å—é
        function applyPreviewFilters() {
            const preview = document.getElementById('preview-canvas');
            if (!preview) return;
            
            const rotation = parseFloat(document.getElementById('rotation-slider').value);
            preview.style.transform = `rotate(${rotation}deg)`;
        }
        
        // –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞
        function setRotation(degrees) {
            document.getElementById('rotation-slider').value = degrees;
            document.getElementById('rotation-value').textContent = degrees + '¬∞';
            applyPreviewFilters();
        }
        

        
        function uploadNewPhoto() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å: –ª–∏–±–æ –∏–∑ editModal, –ª–∏–±–æ –∏–∑ currentProfile (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã)
            const profileName = currentEditProfile || currentProfile;
            if (!newPhotoFile || !profileName) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            const quantityInput = document.getElementById('edit-quantity');
            const lengthInput = document.getElementById('edit-length');
            const notesInput = document.getElementById('edit-notes');
            
            const quantity = quantityInput ? quantityInput.value : '';
            const length = lengthInput ? lengthInput.value : '';
            const notes = notesInput ? notesInput.value : '';
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—Ä–æ–ø–∞ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É
            const scale = cropCanvas.width / cropImage.width;
            const scaledCrop = {
                x: cropData.x / scale,
                y: cropData.y / scale,
                width: cropData.width / scale,
                height: cropData.height / scale
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const rotation = parseFloat(document.getElementById('rotation-slider').value);
            
            fetch('/api/profiles/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    profile_name: profileName,
                    image_data: newPhotoFile,
                    crop_data: scaledCrop,
                    quantity_per_hanger: quantity ? parseInt(quantity) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes,
                    rotation: rotation
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                    closePhotoUpload();
                    closeEditModal();
                    
                    // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ
                    if (isEditMode && currentView === 'table') {
                        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ currentUploadingRow (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ã—á–Ω—ã–º –∏–º–µ–Ω–µ–º –∏–ª–∏ new-X)
                        const rowId = currentUploadingRow || profileName;
                        const row = document.getElementById(`row-${rowId}`);
                        if (row) {
                            const photoCell = row.querySelector('td:first-child');
                            if (photoCell) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–µ–ª—ë–Ω—É—é –≥–∞–ª–æ—á–∫—É —á—Ç–æ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                                const clickHandler = rowId.startsWith('new-') 
                                    ? `uploadPhotoForNewRow('${rowId}')`
                                    : `handlePhotoClick('${profileName}', '')`;
                                
                                photoCell.innerHTML = `
                                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                                                border-radius: 6px; display: flex; align-items: center; justify-content: center; 
                                                color: white; font-size: 32px; cursor: pointer;" 
                                         onclick="${clickHandler}" 
                                         title="–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –ë—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è">
                                        ‚úì
                                    </div>
                                `;
                            }
                        }
                        // –û—á–∏—â–∞–µ–º currentUploadingRow
                        currentUploadingRow = null;
                    } else {
                        // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                        loadCatalog();
                    }
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}`);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = '‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ';
            });
        }
        
        function saveProfile() {
            if (!currentEditProfile) return;
            
            const quantity = document.getElementById('edit-quantity').value;
            const length = document.getElementById('edit-length').value;
            const notes = document.getElementById('edit-notes').value;
            
            fetch(`/api/catalog/${encodeURIComponent(currentEditProfile)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quantity_per_hanger: quantity ? parseInt(quantity) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    closeEditModal();
                    loadCatalog();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message}`);
            });
        }
        
        function deleteProfile(name) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${name}"?`)) {
                alert('–£–¥–∞–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }
        
        let searchTimeout;
        function searchCatalog() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadCatalog();
            }, 500);
        }
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑—É–º–∞ –≤ catalog
        let catalogZoom = 1;
        let catalogDragging = false;
        let catalogStartX, catalogStartY, catalogScrollLeft, catalogScrollTop;
        
        function viewPhoto(name, photoUrl) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('modal-photo');
            const title = document.getElementById('modal-photo-title');
            
            img.src = photoUrl;
            title.textContent = name;
            modal.classList.add('active');
            
            // –°–±—Ä–æ—Å –∑—É–º–∞
            catalogZoom = 1;
            img.style.transform = `scale(${catalogZoom})`;
            img.style.cursor = 'zoom-in';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑—É–º–∞
            setupCatalogPhotoZoom(img);
        }
        
        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
            catalogZoom = 1;
        }
        
        function setupCatalogPhotoZoom(img) {
            const modalContent = img.parentElement;
            
            // –ó—É–º –∫–æ–ª—ë—Å–∏–∫–æ–º –º—ã—à–∏
            modalContent.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.15 : 0.15;
                catalogZoom = Math.max(0.5, Math.min(5, catalogZoom + delta));
                img.style.transform = `scale(${catalogZoom})`;
                img.style.cursor = catalogZoom > 1 ? 'move' : 'zoom-in';
                img.style.transition = 'transform 0.1s ease';
            };
            
            // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∑—É–º–∞
            img.ondblclick = (e) => {
                e.stopPropagation();
                catalogZoom = catalogZoom === 1 ? 2.5 : 1;
                img.style.transform = `scale(${catalogZoom})`;
                img.style.cursor = catalogZoom > 1 ? 'move' : 'zoom-in';
            };
            
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑—É–º–µ
            img.onmousedown = (e) => {
                if (catalogZoom > 1) {
                    e.preventDefault();
                    catalogDragging = true;
                    catalogStartX = e.pageX - modalContent.offsetLeft;
                    catalogStartY = e.pageY - modalContent.offsetTop;
                    catalogScrollLeft = modalContent.scrollLeft;
                    catalogScrollTop = modalContent.scrollTop;
                    img.style.cursor = 'grabbing';
                }
            };
            
            modalContent.onmousemove = (e) => {
                if (!catalogDragging) return;
                e.preventDefault();
                const x = e.pageX - modalContent.offsetLeft;
                const y = e.pageY - modalContent.offsetTop;
                const walkX = (x - catalogStartX) * 2;
                const walkY = (y - catalogStartY) * 2;
                modalContent.scrollLeft = catalogScrollLeft - walkX;
                modalContent.scrollTop = catalogScrollTop - walkY;
            };
            
            modalContent.onmouseup = () => {
                catalogDragging = false;
                if (catalogZoom > 1) {
                    img.style.cursor = 'move';
                }
            };
            
            modalContent.onmouseleave = () => {
                catalogDragging = false;
            };
        }
        
        function deleteProfile(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${name}" –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞?\n\n–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ó–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n- –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è`)) {
                return;
            }
            
            fetch(`/api/catalog/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadCatalog();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${err.message}`);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–µ–ª—ë–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                font-weight: 600;
                font-size: 15px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCatalog();
    </script>
    <style>
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    </style>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
    <div class="modal" id="photo-modal" onclick="if(event.target === this) closePhotoModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closePhotoModal()">√ó</span>
            <h2 id="modal-photo-title" style="margin-bottom: 20px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <img id="modal-photo" class="modal-image" src="" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è">
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="edit-modal" onclick="if(event.target === this) closeEditModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">√ó</span>
            <h2 style="margin-bottom: 20px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è: <span id="edit-profile-name"></span></h2>
            
            <!-- –¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ -->
            <div id="current-photo-section" style="margin-bottom: 20px; text-align: center;">
                <p style="font-weight: 500; margin-bottom: 10px;">–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ:</p>
                <img id="current-photo" src="" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="margin-top: 10px;">
                    <button class="btn-secondary" onclick="showPhotoUpload()" style="padding: 8px 16px;">üì∑ –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
            </div>
            
            <div style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å:</label>
                    <input type="number" id="edit-quantity" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–î–ª–∏–Ω–∞ (–º–º):</label>
                    <input type="number" id="edit-length" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="saveProfile()" style="flex: 1; padding: 12px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeEditModal()" style="padding: 12px 24px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è - –®–∞–≥ 1: –î–∞–Ω–Ω—ã–µ -->
    <div class="modal" id="create-modal-step1" onclick="if(event.target === this) closeCreateModal()">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeCreateModal()">√ó</span>
            <h2 style="margin-bottom: 20px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å (—à–∞–≥ 1/2)</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è</p>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #e11d48;">* –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
                    <input type="text" id="create-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Æ–ü-1625" 
                           style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å:</label>
                    <input type="number" id="create-quantity" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50" 
                           style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–î–ª–∏–Ω–∞ (–º–º):</label>
                    <input type="number" id="create-length" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 6000" 
                           style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                    <textarea id="create-notes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." 
                              style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="goToCreateStep2()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">‚û°Ô∏è –î–∞–ª–µ–µ: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                <button class="btn-secondary" onclick="closeCreateModal()" style="padding: 12px 24px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è - –®–∞–≥ 2: –§–æ—Ç–æ (–∫–æ–ø–∏—è upload-photo-modal) -->
    <div class="modal" id="create-modal-step2" onclick="if(event.target === this) closeCreateModal()">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeCreateModal()">√ó</span>
            <h2 style="margin-bottom: 20px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å (—à–∞–≥ 2/2)</h2>
            
            <input type="file" id="create-photo-file" accept="image/*" style="display: none;" onchange="handleCreatePhotoSelect(event)">
            
            <div id="create-upload-zone" onclick="document.getElementById('create-photo-file').click()" 
                 style="border: 3px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                <p style="color: #6b7280; margin: 0; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</p>
                <p style="color: #9ca3af; font-size: 13px; margin-top: 8px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ <kbd style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 12px;">Ctrl+V</kbd></p>
            </div>
            
            <div id="create-photo-preview" style="display: none;">
                <p style="font-weight: 500; margin-bottom: 10px;">‚úÇÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø—Ä–µ–≤—å—é:</p>
                <div style="display: grid; grid-template-columns: 1fr 220px; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 10px;">
                            üí° <strong>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Ä–∞–º–∫—É</strong> –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                        </p>
                        <canvas id="create-crop-canvas" style="max-width: 100%; border: 2px solid #cbd5e1; border-radius: 8px;"></canvas>
                    </div>
                    <div>
                        <p style="font-weight: 500; font-size: 13px; margin-bottom: 10px; text-align: center;">üëÅÔ∏è –ü—Ä–µ–≤—å—é (300px):</p>
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb; text-align: center;">
                            <canvas id="create-preview-canvas" style="max-width: 100%; max-height: 200px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></canvas>
                            <p style="font-size: 11px; color: #9ca3af; margin-top: 10px;" id="create-preview-size">‚Äî</p>
                        </div>
                        
                        <!-- –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–µ–≤—å—é -->
                        <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px;">
                            <label style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #4b5563; font-weight: 500;">
                                <span>üîÑ –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–µ–≤—å—é:</span>
                                <span id="create-rotation-value">0¬∞</span>
                            </label>
                            <input type="range" id="create-rotation-slider" min="0" max="360" step="90" value="0" 
                                   style="width: 100%;" oninput="document.getElementById('create-rotation-value').textContent = this.value + '¬∞'; applyCreatePreviewFilters()">
                            <div style="display: flex; gap: 4px; margin-top: 8px;">
                                <button onclick="setCreateRotation(0)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">0¬∞</button>
                                <button onclick="setCreateRotation(90)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">90¬∞</button>
                                <button onclick="setCreateRotation(180)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">180¬∞</button>
                                <button onclick="setCreateRotation(270)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">270¬∞</button>
                            </div>
                        </div>
                        
                        <button onclick="resetCreateCrop()" style="width: 100%; margin-top: 10px; padding: 8px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-secondary" onclick="backToCreateStep1()" style="padding: 12px 24px;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
                    <button class="btn-primary" onclick="createNewProfile()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">‚úÖ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
    <div class="modal" id="upload-photo-modal" onclick="if(event.target === this) closePhotoUpload()">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closePhotoUpload()">√ó</span>
            <h2 style="margin-bottom: 20px;">üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ</h2>
            
            <input type="file" id="photo-file" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
            
            <div id="upload-zone" onclick="document.getElementById('photo-file').click()" 
                 style="border: 3px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                <p style="color: #6b7280; margin: 0; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ</p>
                <p style="color: #9ca3af; font-size: 13px; margin-top: 8px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ <kbd style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 12px;">Ctrl+V</kbd></p>
            </div>
            
            <div id="photo-preview" style="display: none;">
                <p style="font-weight: 500; margin-bottom: 10px;">‚úÇÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø—Ä–µ–≤—å—é:</p>
                <div style="display: grid; grid-template-columns: 1fr 220px; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 10px;">
                            üí° <strong>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Ä–∞–º–∫—É</strong> –∏–ª–∏ <strong>—Ç—è–Ω–∏—Ç–µ –∑–∞ —É–≥–ª—ã</strong> –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                        </p>
                        <canvas id="crop-canvas" style="max-width: 100%; border: 2px solid #cbd5e1; border-radius: 8px;"></canvas>
                    </div>
                    <div>
                        <p style="font-weight: 500; font-size: 13px; margin-bottom: 10px; text-align: center;">üëÅÔ∏è –ü—Ä–µ–≤—å—é (300px):</p>
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb; text-align: center;">
                            <canvas id="preview-canvas" style="max-width: 100%; max-height: 200px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: filter 0.2s;"></canvas>
                            <p style="font-size: 11px; color: #9ca3af; margin-top: 10px;" id="preview-size">‚Äî</p>
                        </div>
                        
                        <!-- –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–µ–≤—å—é -->
                        <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px;">
                            <label style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #4b5563; font-weight: 500;">
                                <span>üîÑ –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–µ–≤—å—é:</span>
                                <span id="rotation-value">0¬∞</span>
                            </label>
                            <input type="range" id="rotation-slider" min="0" max="360" step="90" value="0" 
                                   style="width: 100%;" oninput="document.getElementById('rotation-value').textContent = this.value + '¬∞'; applyPreviewFilters()">
                            <div style="display: flex; gap: 4px; margin-top: 8px;">
                                <button onclick="setRotation(0)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">0¬∞</button>
                                <button onclick="setRotation(90)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">90¬∞</button>
                                <button onclick="setRotation(180)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">180¬∞</button>
                                <button onclick="setRotation(270)" style="flex: 1; padding: 6px; font-size: 11px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">270¬∞</button>
                            </div>
                        </div>
                        
                        <button onclick="resetCrop()" style="width: 100%; margin-top: 10px; padding: 8px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-primary" onclick="uploadNewPhoto()" style="flex: 1; padding: 12px;">‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


