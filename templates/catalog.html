<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π - Ekranchik</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 0 20px 0;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #f3f4f6;
            margin-bottom: 20px;
            position: sticky;
            top: 20px;
            z-index: 100;
            display: grid;
            grid-template-columns: minmax(200px, auto) auto 1fr;
            gap: 30px;
            align-items: center;
        }
        
        .header-title {
            white-space: nowrap;
        }
        
        .nav-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .header-stats {
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-nav {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-nav.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3), 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: scale(1.05);
        }
        
        .header h1 {
            color: #1f2937;
            font-size: 28px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .stat-item {
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .profile-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }
        
        .profile-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .profile-photo {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-photo:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .profile-photo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-close:hover {
            color: #1f2937;
        }
        
        .modal-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .profile-photo.no-photo {
            color: #9ca3af;
            font-size: 48px;
        }
        
        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .profile-params {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .param-label {
            color: #6b7280;
        }
        
        .param-value {
            color: #1f2937;
            font-weight: 500;
        }
        
        .profile-notes {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .profile-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            flex: 1;
            background: #3b82f6;
            color: white;
            padding: 8px;
            font-size: 13px;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 16px;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π</h1>
                <p style="color: #6b7280; margin-top: 4px; font-size: 12px;">–í—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Å —Ñ–æ—Ç–æ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</p>
            </div>
            <div class="nav-buttons">
                <button class="btn-nav" onclick="window.location.href='/'">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                <button class="btn-nav" onclick="window.location.href='/profiles'">üì∑ –ü—Ä–æ—Ñ–∏–ª–∏</button>
                <button class="btn-nav active">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
            </div>
            <div class="header-stats">
                <div class="stats">
                    <div class="stat-item">
                        <strong id="total-profiles">0</strong> –ø—Ä–æ—Ñ–∏–ª–µ–π
                    </div>
                    <button class="btn-primary" onclick="loadCatalog()" style="margin-left: 20px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
        
        <div style="padding: 0 30px; margin-bottom: 20px;">
            <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π..." 
                   style="width: 100%; padding: 12px 20px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 15px;"
                   onkeyup="searchCatalog()">
        </div>
        
        <div id="catalog-container" style="padding: 0 30px;">
            <div class="loading">
                <div class="spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞...
            </div>
        </div>
    </div>
    
    <script>
        function loadCatalog() {
            const container = document.getElementById('catalog-container');
            const searchValue = document.getElementById('search-input').value.trim();
            container.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞...</div>';
            
            const url = searchValue ? `/api/catalog?search=${encodeURIComponent(searchValue)}` : '/api/catalog';
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = '<div class="loading" style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }
                    
                    document.getElementById('total-profiles').textContent = data.total;
                    
                    if (data.profiles.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <h3>üì≠ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—É—Å—Ç</h3>
                                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª–µ–π —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∑–¥–µ—Å—å</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const grid = document.createElement('div');
                    grid.className = 'catalog-grid';
                    
                    data.profiles.forEach(profile => {
                        const card = document.createElement('div');
                        card.className = 'profile-card';
                        
                        const photoHtml = profile.photo_thumb 
                            ? `<img src="${profile.photo_thumb}" alt="${profile.name}">`
                            : '<div class="no-photo">üì∑</div>';
                        
                        const photoClickHandler = profile.photo_full 
                            ? `onclick="viewPhoto('${profile.name}', '${profile.photo_full}')"`
                            : '';
                        
                        const quantityHtml = profile.quantity_per_hanger 
                            ? `<div class="param-row">
                                <span class="param-label">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å:</span>
                                <span class="param-value">${profile.quantity_per_hanger}</span>
                               </div>`
                            : '';
                        
                        const lengthHtml = profile.length
                            ? `<div class="param-row">
                                <span class="param-label">–î–ª–∏–Ω–∞:</span>
                                <span class="param-value">${profile.length} –º–º</span>
                               </div>`
                            : '';
                        
                        const notesHtml = profile.notes || '–ù–µ—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏–π';
                        
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è JSON
                        const profileDataJson = JSON.stringify({
                            name: profile.name,
                            quantity_per_hanger: profile.quantity_per_hanger,
                            length: profile.length,
                            notes: profile.notes
                        }).replace(/"/g, '&quot;');
                        
                        card.innerHTML = `
                            <div class="profile-photo ${profile.photo_thumb ? '' : 'no-photo'}" ${photoClickHandler}>
                                ${photoHtml}
                            </div>
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-params">
                                ${quantityHtml}
                                ${lengthHtml}
                            </div>
                            <div class="profile-notes">${notesHtml}</div>
                            <div class="profile-actions">
                                <button class="btn-edit" onclick='editProfile(${profileDataJson})'>‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button class="btn-delete" onclick="deleteProfile('${profile.name}')">üóëÔ∏è</button>
                            </div>
                        `;
                        
                        grid.appendChild(card);
                    });
                    
                    container.innerHTML = '';
                    container.appendChild(grid);
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞:', err);
                    container.innerHTML = '<div class="loading" style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                });
        }
        
        let currentEditProfile = null;
        let currentEditProfileData = null;
        let newPhotoFile = null;
        let cropCanvas = null;
        let cropCtx = null;
        let cropImage = null;
        let cropData = { x: 0, y: 0, width: 0, height: 0 };
        let cropMode = 'none'; // 'none', 'move', 'resize-tl', 'resize-tr', 'resize-bl', 'resize-br'
        let dragStartX = 0;
        let dragStartY = 0;
        let initialCropData = null;
        
        function editProfile(profileData) {
            currentEditProfile = profileData.name;
            currentEditProfileData = profileData;
            
            document.getElementById('edit-profile-name').textContent = profileData.name;
            document.getElementById('edit-quantity').value = profileData.quantity_per_hanger || '';
            document.getElementById('edit-length').value = profileData.length || '';
            document.getElementById('edit-notes').value = profileData.notes || '';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ DOM –¥–ª—è —Ñ–æ—Ç–æ
            const profileCard = event.target.closest('.profile-card');
            const photoImg = profileCard?.querySelector('.profile-photo img');
            const currentPhoto = document.getElementById('current-photo');
            
            if (photoImg && photoImg.src) {
                currentPhoto.src = photoImg.src;
                document.getElementById('current-photo-section').style.display = 'block';
            } else {
                document.getElementById('current-photo-section').style.display = 'none';
            }
            
            document.getElementById('edit-modal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditProfile = null;
            currentEditProfileData = null;
            newPhotoFile = null;
        }
        
        function showPhotoUpload() {
            document.getElementById('upload-photo-modal').classList.add('active');
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('upload-zone').style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞
            document.addEventListener('paste', handlePaste);
        }
        
        function closePhotoUpload() {
            document.getElementById('upload-photo-modal').classList.remove('active');
            newPhotoFile = null;
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏
            document.removeEventListener('paste', handlePaste);
        }
        
        function handlePaste(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
            if (!document.getElementById('upload-photo-modal').classList.contains('active')) {
                return;
            }
            
            const items = event.clipboardData?.items;
            if (!items) return;
            
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            loadImageForCrop(e.target.result);
                        };
                        reader.readAsDataURL(file);
                        event.preventDefault();
                        break;
                    }
                }
            }
        }
        
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                loadImageForCrop(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function loadImageForCrop(imageData) {
            newPhotoFile = imageData;
            
            cropImage = new Image();
            cropImage.onload = function() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas
                cropCanvas = document.getElementById('crop-canvas');
                cropCtx = cropCanvas.getContext('2d');
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
                const maxWidth = 500;
                const scale = Math.min(1, maxWidth / cropImage.width);
                cropCanvas.width = cropImage.width * scale;
                cropCanvas.height = cropImage.height * scale;
                
                // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—Ä–æ–ø - –ö–í–ê–î–†–ê–¢ –ø–æ —Ü–µ–Ω—Ç—Ä—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
                const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6; // 60% –æ—Ç –º–µ–Ω—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã
                cropData = {
                    x: (cropCanvas.width - recommendedSize) / 2,
                    y: (cropCanvas.height - recommendedSize) / 2,
                    width: recommendedSize,
                    height: recommendedSize
                };
                
                drawCropBox();
                updatePreview();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                document.getElementById('photo-preview').style.display = 'block';
                document.getElementById('upload-zone').style.display = 'none';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                initCropHandlers();
            };
            cropImage.src = imageData;
        }
        
        function initCropHandlers() {
            cropCanvas.addEventListener('mousedown', handleCropMouseDown);
            document.addEventListener('mousemove', handleCropMouseMove);
            document.addEventListener('mouseup', handleCropMouseUp);
        }
        
        function getCursorMode(mouseX, mouseY) {
            const handleSize = 10; // –†–∞–∑–º–µ—Ä –∑–æ–Ω—ã –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —É–≥–ª–∞
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–ª—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if (Math.abs(mouseX - cropData.x) < handleSize && Math.abs(mouseY - cropData.y) < handleSize) {
                return 'resize-tl'; // top-left
            }
            if (Math.abs(mouseX - (cropData.x + cropData.width)) < handleSize && Math.abs(mouseY - cropData.y) < handleSize) {
                return 'resize-tr'; // top-right
            }
            if (Math.abs(mouseX - cropData.x) < handleSize && Math.abs(mouseY - (cropData.y + cropData.height)) < handleSize) {
                return 'resize-bl'; // bottom-left
            }
            if (Math.abs(mouseX - (cropData.x + cropData.width)) < handleSize && Math.abs(mouseY - (cropData.y + cropData.height)) < handleSize) {
                return 'resize-br'; // bottom-right
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏ (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ)
            if (mouseX >= cropData.x && mouseX <= cropData.x + cropData.width &&
                mouseY >= cropData.y && mouseY <= cropData.y + cropData.height) {
                return 'move';
            }
            
            return 'none';
        }
        
        function getCursorStyle(mode) {
            const cursors = {
                'none': 'crosshair',
                'move': 'move',
                'resize-tl': 'nwse-resize',
                'resize-tr': 'nesw-resize',
                'resize-bl': 'nesw-resize',
                'resize-br': 'nwse-resize'
            };
            return cursors[mode] || 'default';
        }
        
        function updateCursor() {
            cropCanvas.style.cursor = getCursorStyle(cropMode);
        }
        
        function handleCropMouseDown(e) {
            const rect = cropCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            cropMode = getCursorMode(mouseX, mouseY);
            
            if (cropMode !== 'none') {
                dragStartX = mouseX;
                dragStartY = mouseY;
                initialCropData = { ...cropData };
                updateCursor();
            }
        }
        
        function handleCropMouseMove(e) {
            if (!cropCanvas) return;
            
            const rect = cropCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (cropMode === 'none') {
                // –ü—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                const mode = getCursorMode(mouseX, mouseY);
                cropCanvas.style.cursor = getCursorStyle(mode);
                return;
            }
            
            const dx = mouseX - dragStartX;
            const dy = mouseY - dragStartY;
            
            if (cropMode === 'move') {
                // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                cropData.x = Math.max(0, Math.min(cropCanvas.width - cropData.width, initialCropData.x + dx));
                cropData.y = Math.max(0, Math.min(cropCanvas.height - cropData.height, initialCropData.y + dy));
            } else if (cropMode.startsWith('resize-')) {
                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                if (cropMode === 'resize-tl') {
                    cropData.x = Math.max(0, Math.min(initialCropData.x + initialCropData.width - 20, initialCropData.x + dx));
                    cropData.y = Math.max(0, Math.min(initialCropData.y + initialCropData.height - 20, initialCropData.y + dy));
                    cropData.width = initialCropData.width - (cropData.x - initialCropData.x);
                    cropData.height = initialCropData.height - (cropData.y - initialCropData.y);
                } else if (cropMode === 'resize-tr') {
                    cropData.y = Math.max(0, Math.min(initialCropData.y + initialCropData.height - 20, initialCropData.y + dy));
                    cropData.width = Math.max(20, Math.min(cropCanvas.width - cropData.x, initialCropData.width + dx));
                    cropData.height = initialCropData.height - (cropData.y - initialCropData.y);
                } else if (cropMode === 'resize-bl') {
                    cropData.x = Math.max(0, Math.min(initialCropData.x + initialCropData.width - 20, initialCropData.x + dx));
                    cropData.width = initialCropData.width - (cropData.x - initialCropData.x);
                    cropData.height = Math.max(20, Math.min(cropCanvas.height - cropData.y, initialCropData.height + dy));
                } else if (cropMode === 'resize-br') {
                    cropData.width = Math.max(20, Math.min(cropCanvas.width - cropData.x, initialCropData.width + dx));
                    cropData.height = Math.max(20, Math.min(cropCanvas.height - cropData.y, initialCropData.height + dy));
                }
            }
            
            drawCropBox();
            updatePreview();
        }
        
        function handleCropMouseUp() {
            cropMode = 'none';
            cropCanvas.style.cursor = 'move';
        }
        
        function drawCropBox() {
            if (!cropCanvas || !cropCtx || !cropImage) return;
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // –ó–∞—Ç–µ–º–Ω—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
            cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
            
            // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å
            cropCtx.clearRect(cropData.x, cropData.y, cropData.width, cropData.height);
            cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É
            cropCtx.strokeStyle = '#3b82f6';
            cropCtx.lineWidth = 2;
            cropCtx.strokeRect(cropData.x, cropData.y, cropData.width, cropData.height);
            
            // –†–∏—Å—É–µ–º —É–≥–ª—ã –¥–ª—è resize
            const handleSize = 8;
            cropCtx.fillStyle = '#3b82f6';
            
            // Top-left
            cropCtx.fillRect(cropData.x - handleSize/2, cropData.y - handleSize/2, handleSize, handleSize);
            // Top-right
            cropCtx.fillRect(cropData.x + cropData.width - handleSize/2, cropData.y - handleSize/2, handleSize, handleSize);
            // Bottom-left
            cropCtx.fillRect(cropData.x - handleSize/2, cropData.y + cropData.height - handleSize/2, handleSize, handleSize);
            // Bottom-right
            cropCtx.fillRect(cropData.x + cropData.width - handleSize/2, cropData.y + cropData.height - handleSize/2, handleSize, handleSize);
        }
        
        function updatePreview() {
            const previewCanvas = document.getElementById('preview-canvas');
            if (!previewCanvas || !cropImage) return;
            
            const previewCtx = previewCanvas.getContext('2d');
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –æ—Ç canvas –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
            const scale = cropImage.width / cropCanvas.width;
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
            const srcX = cropData.x * scale;
            const srcY = cropData.y * scale;
            const srcWidth = cropData.width * scale;
            const srcHeight = cropData.height * scale;
            
            // Resize –¥–æ 300px max (—Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏)
            const maxSize = 300;
            let previewWidth = srcWidth;
            let previewHeight = srcHeight;
            
            if (previewWidth > maxSize || previewHeight > maxSize) {
                if (previewWidth > previewHeight) {
                    previewHeight = (previewHeight / previewWidth) * maxSize;
                    previewWidth = maxSize;
                } else {
                    previewWidth = (previewWidth / previewHeight) * maxSize;
                    previewHeight = maxSize;
                }
            }
            
            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;
            
            // –†–∏—Å—É–µ–º –ø—Ä–µ–≤—å—é
            previewCtx.drawImage(
                cropImage,
                srcX, srcY, srcWidth, srcHeight,
                0, 0, previewWidth, previewHeight
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
            const sizeText = document.getElementById('preview-size');
            if (sizeText) {
                sizeText.textContent = `${Math.round(previewWidth)}√ó${Math.round(previewHeight)}px`;
            }
        }
        
        function resetCrop() {
            if (!cropCanvas) return;
            
            // –°–±—Ä–æ—Å –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä (–∫–≤–∞–¥—Ä–∞—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É)
            const recommendedSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.6;
            cropData = {
                x: (cropCanvas.width - recommendedSize) / 2,
                y: (cropCanvas.height - recommendedSize) / 2,
                width: recommendedSize,
                height: recommendedSize
            };
            
            drawCropBox();
            updatePreview();
        }
        
        function uploadNewPhoto() {
            if (!newPhotoFile || !currentEditProfile) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è
            const quantity = document.getElementById('edit-quantity').value;
            const length = document.getElementById('edit-length').value;
            const notes = document.getElementById('edit-notes').value;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—Ä–æ–ø–∞ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É
            const scale = cropCanvas.width / cropImage.width;
            const scaledCrop = {
                x: cropData.x / scale,
                y: cropData.y / scale,
                width: cropData.width / scale,
                height: cropData.height / scale
            };
            
            fetch('/api/profiles/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    profile_name: currentEditProfile,
                    image_data: newPhotoFile,
                    crop_data: scaledCrop,
                    quantity_per_hanger: quantity ? parseInt(quantity) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                    closePhotoUpload();
                    closeEditModal();
                    loadCatalog();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}`);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = '‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ';
            });
        }
        
        function saveProfile() {
            if (!currentEditProfile) return;
            
            const quantity = document.getElementById('edit-quantity').value;
            const length = document.getElementById('edit-length').value;
            const notes = document.getElementById('edit-notes').value;
            
            fetch(`/api/catalog/${encodeURIComponent(currentEditProfile)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quantity_per_hanger: quantity ? parseInt(quantity) : null,
                    length: length ? parseFloat(length) : null,
                    notes: notes
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    closeEditModal();
                    loadCatalog();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message}`);
            });
        }
        
        function deleteProfile(name) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${name}"?`)) {
                alert('–£–¥–∞–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }
        
        let searchTimeout;
        function searchCatalog() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadCatalog();
            }, 500);
        }
        
        function viewPhoto(name, photoUrl) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('modal-photo');
            const title = document.getElementById('modal-photo-title');
            
            img.src = photoUrl;
            title.textContent = name;
            modal.classList.add('active');
        }
        
        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
        }
        
        function deleteProfile(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${name}" –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞?\n\n–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ó–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n- –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è`)) {
                return;
            }
            
            fetch(`/api/catalog/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadCatalog();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            })
            .catch(err => {
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${err.message}`);
            });
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCatalog();
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
    <div class="modal" id="photo-modal" onclick="if(event.target === this) closePhotoModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closePhotoModal()">√ó</span>
            <h2 id="modal-photo-title" style="margin-bottom: 20px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <img id="modal-photo" class="modal-image" src="" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è">
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="edit-modal" onclick="if(event.target === this) closeEditModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">√ó</span>
            <h2 style="margin-bottom: 20px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è: <span id="edit-profile-name"></span></h2>
            
            <!-- –¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ -->
            <div id="current-photo-section" style="margin-bottom: 20px; text-align: center;">
                <p style="font-weight: 500; margin-bottom: 10px;">–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ:</p>
                <img id="current-photo" src="" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="margin-top: 10px;">
                    <button class="btn-secondary" onclick="showPhotoUpload()" style="padding: 8px 16px;">üì∑ –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
            </div>
            
            <div style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ö–æ–ª-–≤–æ –Ω–∞ –ø–æ–¥–≤–µ—Å:</label>
                    <input type="number" id="edit-quantity" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–î–ª–∏–Ω–∞ (–º–º):</label>
                    <input type="number" id="edit-length" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="saveProfile()" style="flex: 1; padding: 12px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-secondary" onclick="closeEditModal()" style="padding: 12px 24px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
    <div class="modal" id="upload-photo-modal" onclick="if(event.target === this) closePhotoUpload()">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closePhotoUpload()">√ó</span>
            <h2 style="margin-bottom: 20px;">üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ</h2>
            
            <input type="file" id="photo-file" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
            
            <div id="upload-zone" onclick="document.getElementById('photo-file').click()" 
                 style="border: 3px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                <p style="color: #6b7280; margin: 0; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ</p>
                <p style="color: #9ca3af; font-size: 13px; margin-top: 8px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ <kbd style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 12px;">Ctrl+V</kbd></p>
            </div>
            
            <div id="photo-preview" style="display: none;">
                <p style="font-weight: 500; margin-bottom: 10px;">‚úÇÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø—Ä–µ–≤—å—é:</p>
                <div style="display: grid; grid-template-columns: 1fr 220px; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 10px;">
                            üí° <strong>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Ä–∞–º–∫—É</strong> –∏–ª–∏ <strong>—Ç—è–Ω–∏—Ç–µ –∑–∞ —É–≥–ª—ã</strong> –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                        </p>
                        <canvas id="crop-canvas" style="max-width: 100%; border: 2px solid #cbd5e1; border-radius: 8px;"></canvas>
                    </div>
                    <div>
                        <p style="font-weight: 500; font-size: 13px; margin-bottom: 10px; text-align: center;">üëÅÔ∏è –ü—Ä–µ–≤—å—é (300px):</p>
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb; text-align: center;">
                            <canvas id="preview-canvas" style="max-width: 100%; max-height: 200px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></canvas>
                            <p style="font-size: 11px; color: #9ca3af; margin-top: 10px;" id="preview-size">‚Äî</p>
                        </div>
                        <button onclick="resetCrop()" style="width: 100%; margin-top: 10px; padding: 8px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üîÑ –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="uploadNewPhoto()" style="flex: 1; padding: 12px;">‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
