' ========================================
' –ú–ê–ö–†–û–° –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–Ø –î–õ–Ø EXCEL
' ========================================
' 
' –í–ê–ñ–ù–û: –ö–æ–¥ —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ 2 —á–∞—Å—Ç–∏!
'
' –ß–ê–°–¢–¨ 1: –í—Å—Ç–∞–≤–∏—Ç—å –≤ "ThisWorkbook" (—Å–º. –Ω–∏–∂–µ)
' –ß–ê–°–¢–¨ 2: –í—Å—Ç–∞–≤–∏—Ç—å –≤ –æ–±—ã—á–Ω—ã–π "Module" (—Å–º. –Ω–∏–∂–µ)
'
' ========================================

' ==========================================
' –ß–ê–°–¢–¨ 1: –ö–û–î –î–õ–Ø "ThisWorkbook"
' ==========================================
' –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
' 1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª "–£—á–µ—Ç –ö–ü–ó 2025.xlsm"
' 2. Alt+F11 ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä VBA
' 3. –°–ª–µ–≤–∞ –Ω–∞–π–¥–∏—Ç–µ "ThisWorkbook" (–≤ –¥–µ—Ä–µ–≤–µ VBAProject)
' 4. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ "ThisWorkbook"
' 5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏:
' ------------------------------------------

' –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–Ω–∏–≥–∏
Private Sub Workbook_Open()
    ' –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    ScheduleAutoSave
    
    ' –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    MsgBox "‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!" & vbCrLf & _
           "–§–∞–π–ª –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ " & AUTO_SAVE_INTERVAL & " –º–∏–Ω.", _
           vbInformation, "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"
End Sub

' –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∫–Ω–∏–≥–∏
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    On Error Resume Next
    Application.OnTime NextSaveTime, "AutoSaveWorkbook", , False
    On Error GoTo 0
End Sub

' ------------------------------------------
' –ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è ThisWorkbook
' ------------------------------------------


' ==========================================
' –ß–ê–°–¢–¨ 2: –ö–û–î –î–õ–Ø –û–ë–´–ß–ù–û–ì–û MODULE
' ==========================================
' –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
' 1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ VBA (Alt+F11)
' 2. –ú–µ–Ω—é: Insert ‚Üí Module
' 3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏:
' ------------------------------------------

' –ù–ê–°–¢–†–û–ô–ö–ê: –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ú–ò–ù–£–¢–ê–•
Public Const AUTO_SAVE_INTERVAL As Integer = 5  ' –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å: 1, 5, 10, 15 –∏ —Ç.–¥.

' –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
Public NextSaveTime As Date

' –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
Sub ScheduleAutoSave()
    ' –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    On Error Resume Next
    Application.OnTime NextSaveTime, "AutoSaveWorkbook", , False
    On Error GoTo 0
    
    ' –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    NextSaveTime = Now + TimeValue("00:" & Format(AUTO_SAVE_INTERVAL, "00") & ":00")
    Application.OnTime NextSaveTime, "AutoSaveWorkbook"
End Sub

' –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
Sub AutoSaveWorkbook()
    On Error GoTo ErrorHandler
    
    ' –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    ThisWorkbook.Save
    
    ' –õ–æ–≥–∏—Ä—É–µ–º –≤ Immediate Window (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ Ctrl+G –≤ VBA)
    Debug.Print Format(Now, "hh:mm:ss") & " - –§–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω"
    
    ' –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–µ (–Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ)
    Application.StatusBar = "üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: " & Format(Now, "hh:mm:ss")
    
    ' –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –±–∞—Ä —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    Application.Wait (Now + TimeValue("00:00:03"))
    Application.StatusBar = False
    
    ' –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    ScheduleAutoSave
    
    Exit Sub
    
ErrorHandler:
    ' –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
    Debug.Print Format(Now, "hh:mm:ss") & " - –û–®–ò–ë–ö–ê –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " & Err.Description
    
    ' –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
    NextSaveTime = Now + TimeValue("00:01:00")
    Application.OnTime NextSaveTime, "AutoSaveWorkbook"
End Sub

' ------------------------------------------
' –ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è Module
' ------------------------------------------


' ========================================
' –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (—Ç–æ–∂–µ –≤ Module)
' ========================================

' –†—É—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
Sub StopAutoSave()
    On Error Resume Next
    Application.OnTime NextSaveTime, "AutoSaveWorkbook", , False
    On Error GoTo 0
    MsgBox "‚è∏Ô∏è –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", vbInformation, "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"
End Sub

' –†—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
Sub RestartAutoSave()
    ScheduleAutoSave
    MsgBox "‚ñ∂Ô∏è –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ!" & vbCrLf & _
           "–°–ª–µ–¥—É—é—â–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: " & Format(NextSaveTime, "hh:mm:ss"), _
           vbInformation, "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"
End Sub

' –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
Sub CheckAutoSaveStatus()
    If NextSaveTime > Now Then
        Dim minutesLeft As Integer
        minutesLeft = DateDiff("n", Now, NextSaveTime)
        MsgBox "‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ" & vbCrLf & _
               "–ò–Ω—Ç–µ—Ä–≤–∞–ª: " & AUTO_SAVE_INTERVAL & " –º–∏–Ω." & vbCrLf & _
               "–°–ª–µ–¥—É—é—â–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑: " & minutesLeft & " –º–∏–Ω." & vbCrLf & _
               "–í—Ä–µ–º—è: " & Format(NextSaveTime, "hh:mm:ss"), _
               vbInformation, "–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
    Else
        MsgBox "‚ùå –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ" & vbCrLf & _
               "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∞–∫—Ä–æ—Å RestartAutoSave", _
               vbExclamation, "–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
    End If
End Sub
